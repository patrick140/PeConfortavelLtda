{% extends "base_template.html" %}
{% load static %}

    {% block title %}
        <title>Pé Confortavel</title>
    {% endblock %}



            {% block menu %}
            <div class="collapse navbar-collapse justify-content-end" id="mynavbar">
                <div class="navbar-nav">
                    <a href="/" class="nav-link">Início</a>
                    <a href="{% url 'clientes:cadastro' %}" class="nav-link">Cadastro</a>
                    <a href="{% url 'clientes:listar' %}" class="nav-link">Listar</a>
                </div>
            </div>
        </nav>
            {%  endblock %}

            
        {% block titulo_pagina %}
        
        
        {% endblock %}

        {% block corpo %}
        <main class="container m-2 w-75 mx-auto my-font-family">

    <div class="hero">
        <div class="col text-center m-0">
            <h1 class="mt-2 mb-5 my-h2">Cadastro de clientes</h1>
        </div>
    </div>

    <!-- formulario HTML -->
    <section class="hero">
        <form name="frmCadastrar" action="{% url 'clientes:cadastrar' %}" method="post" class="my-label-color-purple">
            {% csrf_token %}
            {% if form.errors %}
<div class="alert alert-danger">
    {% for field, errors in form.errors.items %}
        {% for error in errors %}
            <p><strong>{{ field|title }}:</strong> {{ error }}</p>
        {% endfor %}
    {% endfor %}
</div>
{% endif %}
            
            <!-- Name Field (Full Width) -->
            <div class="row mb-4">
                <div class="col-12">
                    <label for="idNomeClientes" class="form-label">Nome do cliente</label>
                    <input class="form-control form-control-lg" type="text" id="idNomeclientes" name="nome" 
                           placeholder="Informe o nome completo do cliente" minlength="10" maxlength="25" required>
                </div>
            </div>
        
            <!-- CPF and Phone (Equal Columns) -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="idCpf" class="form-label">CPF</label>
                    <input class="form-control" type="text" id="idCpf" name="cpf" 
                        placeholder="000.000.000-00" maxlength="14" required
                        pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" 
                        title="Formato: 000.000.000-00">
                    <div class="form-text">Informe o CPF com pontos e hífen</div>
                </div>
                <div class="col-md-6">
                    <label for="idTelefone" class="form-label">Telefone</label>
                    <input class="form-control" type="text" id="idTelefone" name="telefone" 
                           placeholder="(00) 00000-0000" maxlength="11" required>
                </div>
            </div>
        
            <!-- Address and City (3/4 - 1/4 Ratio) -->
            <div class="row mb-4">
                <div class="col-md-8 mb-3 mb-md-0">
                    <label for="idEndereco" class="form-label">Endereço</label>
                    <input class="form-control" type="text" id="idEndereco" name="endereco" 
                           placeholder="Rua, número, complemento" maxlength="100" required>
                </div>
                <div class="col-md-4">
                    <label for="idCidade" class="form-label">Cidade</label>
                    <input class="form-control" type="text" id="idCidade" name="cidade" 
                           placeholder="Sua cidade" maxlength="50" required>
                </div>
            </div>
        
            <!-- Triple Select Fields (Equal Columns) -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3 mb-md-0">
                    <label for="idUf" class="form-label">Estado (UF)</label>
                    <select class="form-select" id="idUf" name="uf" required>
                        <option value="" selected disabled>Selecione seu estado</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="SP">São Paulo</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="ES">Espírito Santo</option>
                        <option value="PR">Paraná</option>
                        <option value="BA">Bahia</option>
                        <option value="RS">Rio Grande do Sul</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <label for="idContato" class="form-label">Preferência de contato</label>
                    <select class="form-select" id="idContato" name="contato" required>
                        <option value="" selected disabled>Como prefere ser contatado?</option>
                        <option value="C">Carta</option>
                        <option value="E">E-mail</option>
                        <option value="T">Telefone</option>
                        <option value="F">Fax</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="idGenero" class="form-label">Gênero</label>
                    <select class="form-select" id="idGenero" name="genero" required>
                        <option value="" selected disabled>Identificação de gênero</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                        <option value="O">Outro/Prefiro não informar</option>
                    </select>
                </div>
            </div>
        
            <!-- Email and Password (Equal Columns) -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <label for="idEmail" class="form-label">E-mail</label>
                    <input class="form-control" type="email" id="idEmail" name="email" 
                           placeholder="seu@email.com" maxlength="100" required>
                </div>
                <div class="col-md-6">
                    <label for="idSenha" class="form-label">Senha</label>
                    <div class="input-group">
                        <input class="form-control" type="password" id="idSenha" name="senha" 
                               placeholder="Mínimo 8 caracteres" maxlength="256" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div class="form-text">Use letras, números e símbolos</div>
                </div>
            </div>
        
            <!-- Form Buttons (Centered) -->
            <div class="row mt-5">
                <div class="col-12 text-center">
                    <button type="reset" class="btn btn-outline-secondary px-4 me-3">
                        <i class="bi bi-eraser me-2"></i>Limpar
                    </button>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-person-plus me-2"></i>Cadastrar
                    </button>
                </div>
            </div>
        </form>
    </section>

        {% endblock %}

        {% block javascript_complementar %}
        <script>
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('idCpf');
    const form = document.forms['frmCadastrar'];
    
    // CPF format mask with 14-character limit
    cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // Apply formatting
        if (value.length > 3) value = value.replace(/^(\d{3})/, '$1.');
        if (value.length > 6) value = value.replace(/^(\d{3})\.(\d{3})/, '$1.$2.');
        if (value.length > 9) value = value.replace(/^(\d{3})\.(\d{3})\.(\d{3})/, '$1.$2.$3-');
        
        // Enforce 14-character limit (000.000.000-00)
        e.target.value = value.substring(0, 14);
    });

    // Check CPF existence on blur
    cpfInput.addEventListener('blur', function() {
        const cpf = this.value;
        if (cpf.length === 14) {  // Check if fully formatted
            fetch(`/clientes/verificar-cpf/?cpf=${encodeURIComponent(cpf)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback d-block';
                        errorDiv.textContent = 'Este CPF já está cadastrado!';
                        
                        // Remove any existing error message
                        const existingError = this.nextElementSibling;
                        if (existingError && existingError.classList.contains('invalid-feedback')) {
                            existingError.remove();
                        }
                        
                        this.classList.add('is-invalid');
                        this.after(errorDiv);
                        this.focus();
                    } else {
                        this.classList.remove('is-invalid');
                        const errorMsg = this.nextElementSibling;
                        if (errorMsg && errorMsg.classList.contains('invalid-feedback')) {
                            errorMsg.remove();
                        }
                    }
                });
        }
    });
    
    // Clear validation when user starts typing
    cpfInput.addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const errorMsg = this.nextElementSibling;
        if (errorMsg && errorMsg.classList.contains('invalid-feedback')) {
            errorMsg.remove();
        }
    });
});
</script>
        {% endblock %}